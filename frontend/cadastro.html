<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro e Intelig√™ncia - PC/RO</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-masker/1.2.0/vanilla-masker.min.js"></script>

    <style>
        .form-container { max-width: 900px; margin: 0px auto; padding: 20px; }
        
        .top-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .btn-top {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-novo-cadastro {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-novo-cadastro:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .section-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1); }
        .section-title { color: #ffd700; font-size: 18px; margin-bottom: 15px; border-bottom: 1px solid #ffd700; padding-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; text-align: left; }
        .form-group label { font-size: 12px; margin-bottom: 5px; color: #ccc; text-transform: uppercase; }
        .form-group input, .form-group textarea, .form-group select { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 5px; font-family: inherit; }
        
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .photo-upload { 
            position: relative; 
            height: 150px; 
            background: #222; 
            border: 2px dashed #444; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            cursor: pointer; 
            transition: 0.3s; 
        }
        .photo-upload:hover { border-color: #ffd700; }
        .photo-upload img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain;
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 3;
            background: #000;
        }
        .photo-upload input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; }
        .photo-upload i { color: #666; font-size: 24px; position: relative; z-index: 1; pointer-events: none; }
        .photo-upload.has-image i { display: none; }

        .docs-section { margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.4); border-radius: 10px; border: 1px solid rgba(255,215,0,0.2); }
        .docs-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .docs-header h4 { margin: 0; color: #ffd700; font-size: 16px; }
        .docs-counter { background: #ffd700; color: #000; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        
        .doc-item { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 3px 8px rgba(0,0,0,0.3); transition: 0.3s; }
        .doc-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .doc-info { flex: 1; }
        .doc-info h4 { margin: 0; font-size: 14px; color: white; display: flex; align-items: center; gap: 8px; }
        .doc-info p { margin: 5px 0 0 0; font-size: 11px; color: rgba(255,255,255,0.8); }
        .doc-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px; }
        .btn-remove-doc { background: #e74c3c; border: none; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-remove-doc:hover { background: #c0392b; transform: scale(1.05); }
        
        .docs-add-area { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 2px dashed #555; margin-top: 15px; }
        .btn-add-doc { background: linear-gradient(135deg, #27ae60, #229954); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add-doc:hover { background: linear-gradient(135deg, #229954, #1e8449); transform: translateY(-2px); }
        
        .empty-docs { text-align: center; padding: 30px; color: #999; font-style: italic; }
        .empty-docs i { font-size: 48px; margin-bottom: 10px; display: block; opacity: 0.3; }

        .btn-salvar { background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 20px; width: 100%; transition: 0.3s; }
        .btn-salvar:hover { background: linear-gradient(135deg, #20c997, #17a2b8); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(40,167,69,0.4); }
        
        #modal-gerenciar { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content-gerenciar { background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 30px; border-radius: 15px; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto; border: 2px solid #ffd700; }
        .modal-header-gerenciar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #ffd700; }
        .modal-header-gerenciar h2 { margin: 0; color: #ffd700; }
        .search-input { width: 95%; padding: 12px; border: 2px solid #ffd700; border-radius: 8px; font-size: 16px; margin-bottom: 20px; background: #1a1a1a; color: white; }
        .result-item { padding: 15px; border-bottom: 1px solid rgba(255,215,0,0.2); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); margin-bottom: 10px; border-radius: 8px; }
        .result-info strong { color: #ffd700; font-size: 16px; }
        .result-info small { color: #ccc; display: block; margin-top: 5px; }
        .result-actions { display: flex; gap: 8px; }
        .btn-action { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; color: white; transition: 0.3s; font-weight: bold; }
        .btn-action:hover { transform: scale(1.05); box-shadow: 0 3px 10px rgba(0,0,0,0.5); }
        .btn-edit { background: #3498db; }
        .btn-qr { background: #f39c12; }
        .btn-delete { background: #e74c3c; }
        .btn-close-modal { background: #7f8c8d; border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-close-modal:hover { background: #95a5a6; }
        
        .modal-content-gerenciar::-webkit-scrollbar { width: 10px; }
        .modal-content-gerenciar::-webkit-scrollbar-track { background: #1a1a1a; border-radius: 10px; }
        .modal-content-gerenciar::-webkit-scrollbar-thumb { background: #ffd700; border-radius: 10px; }

        /* Estilos personalizados para o modal QR Code */
        .swal2-actions {
            display: flex !important;
            gap: 10px !important;
            width: 100% !important;
            justify-content: center !important;
        }
        
        .btn-download-qr {
            background: linear-gradient(135deg, #27ae60, #229954) !important;
            color: white !important;
            padding: 12px 25px !important;
            border-radius: 8px !important;
            font-weight: bold !important;
            border: none !important;
            cursor: pointer !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 8px !important;
            transition: all 0.3s !important;
        }
        
        .btn-download-qr:hover {
            background: linear-gradient(135deg, #229954, #1e8449) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4) !important;
        }
    </style>
</head>
<body>

    <div class="header">
        <img src="images/logo.png" alt="PC/RO">
    </div>

    <div class="title">
        <h1>ROND√îNIA</h1>
        <h2>POL√çCIA CIVIL</h2>
    </div>

    <div class="top-buttons">
        <button class="btn-top btn-novo-cadastro" onclick="novoCadastro()">
            <i class="fas fa-plus-circle"></i> Novo Cadastro
        </button>
        <button class="btn-top" onclick="abrirModalGerenciar()">
            <i class="fas fa-search"></i> Gerenciar Alvos
        </button>
    </div>

    <div class="form-container">
        <form id="formCadastro" data-modo="create">

            <div class="section-card">
                <div class="section-title"><i class="fas fa-camera"></i> Galeria de Fotos do Alvo</div>
                <div class="photo-grid">
                    <div class="photo-upload">
                        <i class="fas fa-plus"></i>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'prev1')">
                        <img id="prev1" style="display:none;">
                    </div>
                    <div class="photo-upload">
                        <i class="fas fa-plus"></i>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'prev2')">
                        <img id="prev2" style="display:none;">
                    </div>
                    <div class="photo-upload">
                        <i class="fas fa-plus"></i>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'prev3')">
                        <img id="prev3" style="display:none;">
                    </div>
                </div>
            </div>
            
            <div class="section-card">
                <div class="section-title"><i class="fas fa-user"></i> Qualifica√ß√£o do Alvo</div>
                <div class="grid-form">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Nome Completo</label>
                        <input type="text" name="nome" class="capitalize-all" required placeholder="Ex: Jo√£o da Silva">
                    </div>
                    <div class="form-group">
                        <label>CPF</label>
                        <input type="text" name="cpf" id="cpf" placeholder="000.000.000-00">
                    </div>
                    <div class="form-group">
                        <label>RG</label>
                        <input type="text" name="rg">
                    </div>
                    <div class="form-group">
                        <label>Data Nascimento</label>
                        <input type="date" name="data_nascimento">
                    </div>
                    <div class="form-group">
                        <label>UF Naturalidade</label>
                        <select name="uf_natural" id="uf_natural" onchange="carregarCidadesNaturalidade()">
                            <option value="">Selecione</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Naturalidade</label>
                        <select name="naturalidade" id="naturalidade">
                            <option value="">Selecione o Estado primeiro</option>
                        </select>
                    </div>
                </div>
                <div class="grid-form" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Nome da M√£e</label>
                        <input type="text" name="mae" class="capitalize-name">
                    </div>
                    <div class="form-group">
                        <label>Nome do Pai</label>
                        <input type="text" name="pai" class="capitalize-name">
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title"><i class="fas fa-map-marker-alt"></i> Localiza√ß√£o</div>
                <div class="grid-form">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Rua/Logradouro</label>
                        <input type="text" name="rua" class="capitalize-name">
                    </div>
                    <div class="form-group">
                        <label>N√∫mero</label>
                        <input type="text" name="numero">
                    </div>
                    <div class="form-group">
                        <label>Bairro</label>
                        <input type="text" name="bairro" class="capitalize-name">
                    </div>
                    <div class="form-group">
                        <label>UF</label>
                        <select name="uf_endereco" id="uf_endereco" onchange="carregarCidadesEndereco()">
                            <option value="">Selecione</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cidade</label>
                        <select name="cidade" id="cidade">
                            <option value="">Selecione o Estado primeiro</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label>Ponto de Refer√™ncia / Complemento</label>
                    <input type="text" name="complemento" class="capitalize-text">
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label>Observa√ß√µes T√°ticas de Local</label>
                    <textarea name="obs_tacticas" rows="2" class="capitalize-text" placeholder="Descreva caracter√≠sticas t√°ticas relevantes do local..."></textarea>
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label>Link Google Maps</label>
                    <input type="text" name="link_mapa" placeholder="https://maps.google.com/...">
                </div>
            </div>

            <div class="section-card">
                <div class="section-title"><i class="fas fa-brain"></i> Intelig√™ncia e Opera√ß√µes</div>
                
                <div class="form-group">
                    <label><i class="fas fa-user-secret"></i> Envolvimento Criminal / Hist√≥rico</label>
                    <textarea name="envolvimento_alvo" rows="4" class="capitalize-text" placeholder="Descreva o envolvimento do alvo em atividades criminosas, fac√ß√µes, antecedentes..."></textarea>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label><i class="fas fa-clipboard-list"></i> Detalhes da Opera√ß√£o / Mandado</label>
                    <textarea name="detalhes_operacao" rows="4" class="capitalize-text" placeholder="Informa√ß√µes sobre a opera√ß√£o em andamento, natureza do mandado, objetivos..."></textarea>
                </div>
                
                <div class="docs-section">
                    <div class="docs-header">
                        <i class="fas fa-folder-open" style="color: #ffd700; font-size: 20px;"></i>
                        <h4>Documentos Anexos</h4>
                        <span class="docs-counter" id="docs-counter">0</span>
                    </div>
                    
                    <div id="lista-documentos">
                        <div class="empty-docs">
                            <i class="fas fa-file-upload"></i>
                            <p>Nenhum documento anexado ainda</p>
                        </div>
                    </div>

                    <div class="docs-add-area">
                        <input type="file" id="input-documento" accept="application/pdf,image/*" style="display:none;" onchange="adicionarDocumento(this)">
                        
                        <div class="grid-form">
                            <div class="form-group">
                                <label><i class="fas fa-tag"></i> Tipo de Documento</label>
                                <select id="tipo-documento">
                                    <option value="mandado">Mandado Judicial</option>
                                    <option value="boletim">Boletim de Ocorr√™ncia</option>
                                    <option value="relatorio">Relat√≥rio de Investiga√ß√£o</option>
                                    <option value="oficio">Of√≠cio</option>
                                    <option value="foto_investigacao">Foto de Investiga√ß√£o</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-edit"></i> Descri√ß√£o (opcional)</label>
                                <input type="text" id="descricao-documento" class="capitalize-text" placeholder="Ex: Mandado de busca e apreens√£o">
                            </div>
                        </div>
                        
                        <button type="button" class="btn-add-doc" onclick="document.getElementById('input-documento').click()">
                            <i class="fas fa-plus-circle"></i> Adicionar Documento
                        </button>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-salvar" id="btnAcao">
                <i class="fas fa-save"></i> SALVAR REGISTRO OPERACIONAL
            </button>
        </form>
    </div>

    <div id="modal-gerenciar">
        <div class="modal-content-gerenciar">
            <div class="modal-header-gerenciar">
                <h2><i class="fas fa-search"></i> Gerenciar Alvos</h2>
                <button class="btn-close-modal" onclick="fecharModalGerenciar()">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
            <input type="text" id="input-busca" class="search-input" placeholder="üîç Digite o nome ou CPF para buscar..." autocomplete="off">
            <div id="lista-resultados"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ïES GLOBAIS
        // ============================================
        
        let API_URL;
        
        if (window.location.protocol === 'file:' || 
            window.location.hostname === 'localhost' || 
            window.location.hostname === '127.0.0.1') {
            API_URL = "http://localhost:3000";
            console.log('üîß Modo DESENVOLVIMENTO detectado');
        } else {
            API_URL = window.location.origin;
            console.log('üåê Modo PRODU√á√ÉO detectado');
        }

        let documentosAnexados = [];
        let timeoutBusca;

        console.log('='.repeat(60));
        console.log('üöÄ SISTEMA DE CADASTRO INICIADO');
        console.log('üì° API URL:', API_URL);
        console.log('‚è∞ Data/Hora:', new Date().toLocaleString('pt-BR'));
        console.log('='.repeat(60));

        // ============================================
        // FUN√á√ÉO NOVO CADASTRO
        // ============================================
        
        function novoCadastro() {
            Swal.fire({
                title: 'Novo Cadastro',
                text: 'Deseja limpar todos os campos e criar um novo cadastro?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, novo cadastro',
                cancelButtonText: 'Cancelar',
                background: '#1a1a2e',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    limparFormulario();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Formul√°rio Limpo',
                        text: 'Pronto para novo cadastro',
                        toast: true,
                        position: 'top-end',
                        timer: 2000,
                        showConfirmButton: false,
                        background: '#1a1a2e',
                        color: '#fff'
                    });
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        }

        function limparFormulario() {
            const form = document.getElementById('formCadastro');
            
            form.dataset.modo = 'create';
            delete form.dataset.idEdicao;
            
            document.getElementById('btnAcao').innerHTML = '<i class="fas fa-save"></i> SALVAR REGISTRO OPERACIONAL';
            document.getElementById('btnAcao').style.background = "linear-gradient(135deg, #28a745, #20c997)";
            
            form.reset();
            
            ['prev1', 'prev2', 'prev3'].forEach((id, index) => {
                const img = document.getElementById(id);
                const container = img.parentElement;
                img.src = '';
                img.style.display = 'none';
                container.classList.remove('has-image');
                
                const fileInput = container.querySelector('input[type="file"]');
                if (fileInput) fileInput.value = '';
            });
            
            document.getElementById('naturalidade').innerHTML = '<option value="">Selecione o Estado primeiro</option>';
            document.getElementById('cidade').innerHTML = '<option value="">Selecione o Estado primeiro</option>';
            
            documentosAnexados = [];
            renderizarDocumentos();
        }

        // ============================================
        // FUN√á√ïES DE FORMATA√á√ÉO
        // ============================================
        
        function formatarNome(texto) {
            if (!texto) return '';
            const preposicoes = ['de', 'do', 'da', 'dos', 'das', 'e', 'a', 'o', 'as', 'os'];
            const textoLimpo = texto.trim().replace(/\s+/g, ' ');
            
            return textoLimpo.toLowerCase().split(' ').map((palavra, index) => {
                if (index === 0) return palavra.charAt(0).toUpperCase() + palavra.slice(1);
                if (preposicoes.includes(palavra)) return palavra;
                return palavra.charAt(0).toUpperCase() + palavra.slice(1);
            }).join(' ');
        }

        function formatarNomeCompleto(texto) {
            if (!texto) return '';
            return texto.toUpperCase().trim().replace(/\s+/g, ' ');
        }

        function formatarFrase(texto) {
            if (!texto) return '';
            const limpo = texto.trim().replace(/\s+/g, ' ').toLowerCase();
            return limpo.charAt(0).toUpperCase() + limpo.slice(1);
        }

        function aplicarFormatacaoTempoReal(input, tipoFormatacao) {
            const cursorPos = input.selectionStart;
            const valorAtual = input.value;
            if (!valorAtual) return;
            
            let novoTexto = '';
            switch(tipoFormatacao) {
                case 'all':
                    novoTexto = valorAtual.toUpperCase();
                    break;
                case 'name':
                    novoTexto = formatarNomePreservandoEspacos(valorAtual);
                    break;
                case 'text':
                    if (valorAtual.length > 0) {
                        novoTexto = valorAtual.charAt(0).toUpperCase() + valorAtual.slice(1).toLowerCase();
                    }
                    break;
            }
            
            if (novoTexto !== valorAtual) {
                input.value = novoTexto;
                let novoCursorPos = Math.min(cursorPos, novoTexto.length);
                input.setSelectionRange(novoCursorPos, novoCursorPos);
            }
        }

        function formatarNomePreservandoEspacos(texto) {
            if (!texto) return '';
            const preposicoes = ['de', 'do', 'da', 'dos', 'das', 'e', 'a', 'o', 'as', 'os'];
            const palavras = texto.split(' ');
            
            const palavrasFormatadas = palavras.map((palavra, index) => {
                if (palavra === '') return '';
                const palavraLower = palavra.toLowerCase();
                if (index === 0) return palavra.charAt(0).toUpperCase() + palavra.slice(1).toLowerCase();
                if (preposicoes.includes(palavraLower)) return palavraLower;
                return palavra.charAt(0).toUpperCase() + palavra.slice(1).toLowerCase();
            });
            
            return palavrasFormatadas.join(' ');
        }

        // ============================================
        // CARREGAMENTO DE DADOS
        // ============================================
        
        async function carregarEstados() {
            try {
                const res = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome');
                const estados = await res.json();
                
                const selects = ['uf_natural', 'uf_endereco'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    estados.forEach(estado => {
                        const option = document.createElement('option');
                        option.value = estado.sigla;
                        option.textContent = `${estado.sigla} - ${estado.nome}`;
                        select.appendChild(option);
                    });
                });
            } catch (err) {
                console.error('Erro ao carregar estados:', err);
            }
        }

        async function carregarCidadesNaturalidade() {
            const uf = document.getElementById('uf_natural').value;
            const cidadeSelect = document.getElementById('naturalidade');
            cidadeSelect.innerHTML = '<option value="">Carregando...</option>';
            
            if (!uf) {
                cidadeSelect.innerHTML = '<option value="">Selecione o Estado primeiro</option>';
                return;
            }
            
            try {
                const res = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios?orderBy=nome`);
                const cidades = await res.json();
                cidadeSelect.innerHTML = '<option value="">Selecione a Cidade</option>';
                cidades.forEach(cidade => {
                    const option = document.createElement('option');
                    option.value = cidade.nome;
                    option.textContent = cidade.nome;
                    cidadeSelect.appendChild(option);
                });
            } catch (err) {
                console.error('Erro ao carregar cidades:', err);
                cidadeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function carregarCidadesEndereco() {
            const uf = document.getElementById('uf_endereco').value;
            const cidadeSelect = document.getElementById('cidade');
            cidadeSelect.innerHTML = '<option value="">Carregando...</option>';
            
            if (!uf) {
                cidadeSelect.innerHTML = '<option value="">Selecione o Estado primeiro</option>';
                return;
            }
            
            try {
                const res = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios?orderBy=nome`);
                const cidades = await res.json();
                cidadeSelect.innerHTML = '<option value="">Selecione a Cidade</option>';
                cidades.forEach(cidade => {
                    const option = document.createElement('option');
                    option.value = cidade.nome;
                    option.textContent = cidade.nome;
                    cidadeSelect.appendChild(option);
                });
            } catch (err) {
                console.error('Erro ao carregar cidades:', err);
                cidadeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // ============================================
        // PREVIEW E DOCUMENTOS
        // ============================================
        
        function previewImg(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(imgId);
                    const container = img.parentElement;
                    img.src = e.target.result;
                    img.style.display = 'block';
                    container.classList.add('has-image');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function adicionarDocumento(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                Swal.fire('Arquivo muito grande', 'O arquivo deve ter no m√°ximo 10MB', 'warning');
                input.value = '';
                return;
            }

            const tipo = document.getElementById('tipo-documento').value;
            const descricao = document.getElementById('descricao-documento').value || file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result.split(',')[1];
                documentosAnexados.push({
                    tipo: tipo,
                    nome_arquivo: file.name,
                    descricao: formatarFrase(descricao),
                    arquivo_base64: base64,
                    mime_type: file.type
                });
                renderizarDocumentos();
                document.getElementById('descricao-documento').value = '';
                input.value = '';
                Swal.fire({
                    icon: 'success',
                    title: 'Documento Adicionado',
                    toast: true,
                    position: 'top-end',
                    timer: 2000,
                    showConfirmButton: false
                });
            };
            reader.readAsDataURL(file);
        }

        function renderizarDocumentos() {
            const lista = document.getElementById('lista-documentos');
            const counter = document.getElementById('docs-counter');
            counter.textContent = documentosAnexados.length;
            
            if (documentosAnexados.length === 0) {
                lista.innerHTML = '<div class="empty-docs"><i class="fas fa-file-upload"></i><p>Nenhum documento anexado ainda</p></div>';
                return;
            }

            const tipoLabel = {
                'mandado': 'Mandado Judicial',
                'boletim': 'Boletim de Ocorr√™ncia',
                'relatorio': 'Relat√≥rio',
                'oficio': 'Of√≠cio',
                'foto_investigacao': 'Foto de Investiga√ß√£o',
                'outro': 'Outro Documento'
            };

            lista.innerHTML = documentosAnexados.map((doc, index) => {
                const icone = doc.mime_type.includes('pdf') ? 'fa-file-pdf' : 'fa-image';
                const tamanhoKB = (doc.arquivo_base64.length * 0.75 / 1024).toFixed(1);
                return `
                    <div class="doc-item">
                        <div class="doc-info">
                            <h4><i class="fas ${icone}"></i> ${tipoLabel[doc.tipo]}<span class="doc-badge">${tamanhoKB} KB</span></h4>
                            <p><i class="fas fa-file"></i> ${doc.descricao}</p>
                        </div>
                        <button type="button" class="btn-remove-doc" onclick="removerDocumento(${index})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function removerDocumento(index) {
            Swal.fire({
                title: 'Remover Documento?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e74c3c',
                confirmButtonText: 'Sim, remover',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    documentosAnexados.splice(index, 1);
                    renderizarDocumentos();
                    Swal.fire({
                        icon: 'success',
                        title: 'Removido',
                        toast: true,
                        position: 'top-end',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }

        // ============================================
        // SUBMIT DO FORMUL√ÅRIO
        // ============================================
        
        document.getElementById('formCadastro').onsubmit = async (e) => {
            e.preventDefault();
            
            Swal.fire({ 
                title: 'Processando...', 
                html: `<p>Salvando dados e ${documentosAnexados.length} documento(s)...</p>`,
                allowOutsideClick: false, 
                didOpen: () => Swal.showLoading() 
            });

            const form = e.target;
            const formData = new FormData(form);
            const rawData = Object.fromEntries(formData.entries());

            rawData.nome = formatarNomeCompleto(rawData.nome);
            rawData.mae = formatarNome(rawData.mae);
            rawData.pai = formatarNome(rawData.pai);
            rawData.rua = formatarNome(rawData.rua);
            rawData.bairro = formatarNome(rawData.bairro);
            rawData.complemento = formatarFrase(rawData.complemento);
            rawData.obs_tacticas = formatarFrase(rawData.obs_tacticas);
            rawData.envolvimento_alvo = formatarFrase(rawData.envolvimento_alvo);
            rawData.detalhes_operacao = formatarFrase(rawData.detalhes_operacao);
            rawData.modo = form.dataset.modo;
            rawData.idEdicao = form.dataset.idEdicao;

            const getB64 = (id) => {
                const src = document.getElementById(id).src;
                return src && src.includes('base64') ? src.split(',')[1] : null;
            };
            rawData.foto1 = getB64('prev1');
            rawData.foto2 = getB64('prev2');
            rawData.foto3 = getB64('prev3');
            rawData.documentos = documentosAnexados;

            try {
                const res = await fetch(`${API_URL}/cadastrar-alvo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rawData)
                });
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire({
                        title: 'Sucesso!',
                        html: `<p>${data.message}</p><h3 style="color: #28a745;">ID: ${data.id || 'N/A'}</h3>`,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => limparFormulario());
                } else {
                    Swal.fire('Erro', data.error || 'Erro ao salvar', 'error');
                }
            } catch (err) {
                Swal.fire('Erro', 'Falha na conex√£o com servidor.', 'error');
            }
        };

        // ============================================
        // MODAL DE GERENCIAMENTO
        // ============================================
        
        function abrirModalGerenciar() {
            document.getElementById('modal-gerenciar').style.display = 'flex';
            document.getElementById('input-busca').focus();
        }

        function fecharModalGerenciar() {
            document.getElementById('modal-gerenciar').style.display = 'none';
            document.getElementById('input-busca').value = '';
            document.getElementById('lista-resultados').innerHTML = '';
        }

        document.getElementById('input-busca').addEventListener('input', async function(e) {
            clearTimeout(timeoutBusca);
            const termo = e.target.value.trim();
            const lista = document.getElementById('lista-resultados');
            
            if (termo.length < 2) {
                lista.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Digite pelo menos 2 caracteres</p>';
                return;
            }

            lista.innerHTML = '<p style="text-align:center; color:#ffd700; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Buscando...</p>';

            timeoutBusca = setTimeout(async () => {
                try {
                    const res = await fetch(`${API_URL}/buscar-alvos?nome=${encodeURIComponent(termo)}`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const alvos = await res.json();
                    
                    if (!alvos || alvos.length === 0) {
                        lista.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Nenhum resultado encontrado</p>';
                        return;
                    }
                    
                    lista.innerHTML = alvos.map(alvo => `
                        <div class="result-item">
                            <div class="result-info">
                                <strong>${alvo.nome || 'Nome n√£o informado'}</strong>
                                <small>CPF: ${alvo.cpf || 'N√£o informado'} | ID: ${alvo.id}</small>
                            </div>
                            <div class="result-actions">
                                <button class="btn-action btn-edit" onclick="carregarAlvo(${alvo.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn-action btn-qr" onclick="visualizarQR(${alvo.id})"><i class="fas fa-qrcode"></i></button>
                                <button class="btn-action btn-delete" onclick="excluirAlvo(${alvo.id}, '${(alvo.nome || '').replace(/'/g, "\\'")}')"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    `).join('');
                } catch (err) {
                    lista.innerHTML = `<div style="text-align:center; padding:20px; color: #e74c3c;">Erro ao buscar: ${err.message}</div>`;
                }
            }, 500);
        });

        async function carregarAlvo(id) {
            fecharModalGerenciar();
            Swal.fire({ title: 'Carregando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                const res = await fetch(`${API_URL}/buscar-detalhes/${id}`);
                const data = await res.json();
                
                if (data && data.id) {
                    const form = document.getElementById('formCadastro');
                    form.dataset.modo = 'edicao';
                    form.dataset.idEdicao = data.id;
                    document.getElementById('btnAcao').innerHTML = `<i class="fas fa-edit"></i> ATUALIZAR REGISTRO ID: ${data.id}`;
                    document.getElementById('btnAcao').style.background = "linear-gradient(135deg, #ff8c00, #ff6b00)";
                    
                    Object.keys(data).forEach(key => {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input && key !== 'data_nascimento') input.value = data[key] || '';
                    });

                    if (data.data_nascimento) {
                        form.querySelector('[name="data_nascimento"]').value = data.data_nascimento.split('T')[0];
                    }

                    if (data.uf_natural) {
                        document.getElementById('uf_natural').value = data.uf_natural;
                        await carregarCidadesNaturalidade();
                        setTimeout(() => {
                            if (data.naturalidade) document.getElementById('naturalidade').value = data.naturalidade;
                        }, 500);
                    }

                    if (data.uf_endereco) {
                        document.getElementById('uf_endereco').value = data.uf_endereco;
                        await carregarCidadesEndereco();
                        setTimeout(() => {
                            if (data.cidade) document.getElementById('cidade').value = data.cidade;
                        }, 500);
                    }

                    ['foto1', 'foto2', 'foto3'].forEach((foto, i) => {
                        if (data[foto]) {
                            const img = document.getElementById(`prev${i+1}`);
                            img.src = 'data:image/jpeg;base64,' + data[foto];
                            img.style.display = 'block';
                            img.parentElement.classList.add('has-image');
                        }
                    });

                    documentosAnexados = [];
                    if (data.documentos && data.documentos.length > 0) {
                        documentosAnexados = data.documentos.map(doc => ({
                            tipo: doc.tipo_documento,
                            nome_arquivo: doc.nome_arquivo,
                            descricao: doc.descricao,
                            arquivo_base64: doc.arquivo_base64,
                            mime_type: doc.mime_type
                        }));
                        renderizarDocumentos();
                    }

                    Swal.fire({
                        icon: 'info', 
                        title: 'Modo Edi√ß√£o', 
                        text: `Dados do ID ${data.id} carregados`,
                        timer: 3000,
                        background: '#1a1a2e',
                        color: '#fff'
                    });
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (err) {
                Swal.fire('Erro', 'Erro ao buscar dados.', 'error');
            }
        }

        // ============================================
        // VISUALIZAR QR CODE COM DOWNLOAD
        // ============================================
        
        async function visualizarQR(id) {
            fecharModalGerenciar();
            
            setTimeout(async () => {
                try {
                    const res = await fetch(`${API_URL}/buscar-detalhes/${id}`);
                    const data = await res.json();
                    
                    if (data && data.id) {
                        const qrText = `ID: ${data.id}\nNome: ${data.nome}\nCPF: ${data.cpf || 'N/A'}`;
                        
                        Swal.fire({
                            title: `QR Code - ID ${data.id}`,
                            html: `
                                <div style="background: white; padding: 20px; border-radius: 10px; display: inline-block; margin: 20px 0;">
                                    <div id="qrcode-temp"></div>
                                </div>
                                <p style="margin-top: 15px; color: #ffd700; font-weight: bold; font-size: 18px;">${data.nome}</p>
                                <p style="color: #ccc;">CPF: ${data.cpf || 'N√£o informado'}</p>
                            `,
                            width: 500,
                            background: '#1a1a2e',
                            color: '#fff',
                            showCancelButton: true,
                            showDenyButton: true,
                            confirmButtonText: '<i class="fas fa-check"></i> OK',
                            denyButtonText: '<i class="fas fa-download"></i> Baixar QR Code',
                            denyButtonColor: '#27ae60',
                            confirmButtonColor: '#3498db',
                            customClass: {
                                denyButton: 'btn-download-qr'
                            },
                            didOpen: () => {
                                const qrContainer = document.getElementById("qrcode-temp");
                                qrContainer.innerHTML = '';
                                new QRCode(qrContainer, {
                                    text: qrText,
                                    width: 200,
                                    height: 200,
                                    colorDark: "#000000",
                                    colorLight: "#ffffff",
                                    correctLevel: QRCode.CorrectLevel.H
                                });
                            }
                        }).then((result) => {
                            if (result.isDenied) {
                                baixarQRCode(data.nome, data.id);
                            }
                        });
                    }
                } catch (error) {
                    Swal.fire('Erro', 'N√£o foi poss√≠vel gerar o QR Code', 'error');
                }
            }, 100);
        }

        function baixarQRCode(nomeAlvo, idAlvo) {
            try {
                const qrContainer = document.getElementById("qrcode-temp");
                const canvas = qrContainer.querySelector('canvas');
                
                if (!canvas) {
                    Swal.fire('Erro', 'QR Code n√£o encontrado', 'error');
                    return;
                }

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const nomeArquivo = `QRCode_${nomeAlvo.replace(/\s+/g, '_')}_ID${idAlvo}.png`;
                    
                    link.href = url;
                    link.download = nomeArquivo;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    Swal.fire({
                        icon: 'success',
                        title: 'Download Iniciado',
                        text: `Arquivo: ${nomeArquivo}`,
                        toast: true,
                        position: 'top-end',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }, 'image/png');
            } catch (error) {
                console.error('Erro ao baixar QR Code:', error);
                Swal.fire('Erro', 'Falha ao gerar arquivo PNG', 'error');
            }
        }

        async function excluirAlvo(id, nome) {
            fecharModalGerenciar();
            
            setTimeout(async () => {
                const result = await Swal.fire({
                    title: 'Confirmar Exclus√£o',
                    html: `Deseja realmente excluir:<br><strong style="color: #ffd700;">${nome}</strong><br>ID: ${id}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#e74c3c',
                    confirmButtonText: 'Sim, excluir',
                    cancelButtonText: 'Cancelar',
                    background: '#1a1a2e',
                    color: '#fff'
                });

                if (result.isConfirmed) {
                    try {
                        const res = await fetch(`${API_URL}/deletar-alvo/${id}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            Swal.fire({ icon: 'success', title: 'Exclu√≠do', background: '#1a1a2e', color: '#fff' });
                        } else {
                            Swal.fire('Erro', data.error || 'Erro ao excluir', 'error');
                        }
                    } catch (error) {
                        Swal.fire('Erro', 'Falha na conex√£o', 'error');
                    }
                }
            }, 100);
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            carregarEstados();
            VMasker(document.getElementById("cpf")).maskPattern("999.999.999-99");
            
            document.querySelectorAll('.capitalize-all').forEach(input => {
                input.addEventListener('input', function() { aplicarFormatacaoTempoReal(this, 'all'); });
                input.addEventListener('blur', function() { this.value = formatarNomeCompleto(this.value); });
            });
            
            document.querySelectorAll('.capitalize-name').forEach(input => {
                input.addEventListener('input', function() { aplicarFormatacaoTempoReal(this, 'name'); });
                input.addEventListener('blur', function() { this.value = formatarNome(this.value); });
            });

            document.querySelectorAll('.capitalize-text').forEach(input => {
                input.addEventListener('input', function() { aplicarFormatacaoTempoReal(this, 'text'); });
                input.addEventListener('blur', function() { this.value = formatarFrase(this.value); });
            });
        });

        document.getElementById('cpf')?.addEventListener('blur', function() {
            const cpf = this.value.replace(/\D/g, '');
            if (cpf.length > 0 && cpf.length !== 11) {
                Swal.fire({
                    icon: 'warning',
                    title: 'CPF Inv√°lido',
                    toast: true,
                    position: 'top-end',
                    timer: 3000,
                    showConfirmButton: false
                });
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') fecharModalGerenciar();
        });

        renderizarDocumentos();
    </script>
</body>
</html>