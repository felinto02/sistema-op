<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro e Inteligência - PC/RO</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-masker/1.2.0/vanilla-masker.min.js"></script>

    <style>
        .form-container { max-width: 900px; margin: 0px auto; padding: 20px; }
        .admin-menu { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; flex-wrap: wrap; }
        .admin-menu button { background: none; border: 1px solid #ffd700; color: #ffd700; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: 0.3s; font-size: 14px; }
        .admin-menu button:hover { background: #ffd700; color: #000; }
        
        .section-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1); }
        .section-title { color: #ffd700; font-size: 18px; margin-bottom: 15px; border-bottom: 1px solid #ffd700; padding-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; text-align: left; }
        .form-group label { font-size: 12px; margin-bottom: 5px; color: #ccc; text-transform: uppercase; }
        .form-group input, .form-group textarea, .form-group select { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 5px; font-family: inherit; }
        
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .photo-upload { position: relative; height: 150px; background: #222; border: 2px dashed #444; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .photo-upload:hover { border-color: #ffd700; }
        .photo-upload img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .photo-upload input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; }
        .photo-upload i { color: #666; font-size: 24px; position: relative; z-index: 1; pointer-events: none; }

        /* DOCUMENTOS - MELHORADO */
        .docs-section { margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.4); border-radius: 10px; border: 1px solid rgba(255,215,0,0.2); }
        .docs-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .docs-header h4 { margin: 0; color: #ffd700; font-size: 16px; }
        .docs-counter { background: #ffd700; color: #000; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        
        .doc-item { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 3px 8px rgba(0,0,0,0.3); transition: 0.3s; }
        .doc-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .doc-info { flex: 1; }
        .doc-info h4 { margin: 0; font-size: 14px; color: white; display: flex; align-items: center; gap: 8px; }
        .doc-info p { margin: 5px 0 0 0; font-size: 11px; color: rgba(255,255,255,0.8); }
        .doc-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px; }
        .btn-remove-doc { background: #e74c3c; border: none; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-remove-doc:hover { background: #c0392b; transform: scale(1.05); }
        
        .docs-add-area { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 2px dashed #555; margin-top: 15px; }
        .btn-add-doc { background: linear-gradient(135deg, #27ae60, #229954); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add-doc:hover { background: linear-gradient(135deg, #229954, #1e8449); transform: translateY(-2px); }
        
        .empty-docs { text-align: center; padding: 30px; color: #999; font-style: italic; }
        .empty-docs i { font-size: 48px; margin-bottom: 10px; display: block; opacity: 0.3; }

        .btn-salvar { background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 20px; width: 100%; transition: 0.3s; }
        .btn-salvar:hover { background: linear-gradient(135deg, #20c997, #17a2b8); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(40,167,69,0.4); }
        
        /* MODAL BUSCA */
        #modal-qr { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        
        /* LOADING ANIMATION */
        .loading-docs { text-align: center; padding: 20px; color: #ffd700; }
        .loading-docs i { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="header">
        <img src="images/logo.png" alt="PC/RO">
    </div>

    <div class="title">
        <h1>RONDÔNIA</h1>
        <h2>POLÍCIA CIVIL</h2>
    </div>

    <div class="form-container">
        <div class="admin-menu">
            <button onclick="location.href='index.html'"><i class="fas fa-home"></i> Home</button>
            <button onclick="abrirBuscaQR()"><i class="fas fa-search"></i> Buscar por ID</button>
            <button onclick="resetarFormulario()"><i class="fas fa-plus"></i> Novo Cadastro</button>
        </div>

        <form id="formCadastro" data-modo="create">
            <!-- QUALIFICAÇÃO DO ALVO -->
            <div class="section-card">
                <div class="section-title"><i class="fas fa-user"></i> Qualificação do Alvo</div>
                <div class="grid-form">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Nome Completo</label>
                        <input type="text" name="nome" required placeholder="Ex: João da Silva">
                    </div>
                    <div class="form-group">
                        <label>CPF</label>
                        <input type="text" name="cpf" id="cpf" placeholder="000.000.000-00">
                    </div>
                    <div class="form-group">
                        <label>RG</label>
                        <input type="text" name="rg">
                    </div>
                    <div class="form-group">
                        <label>Data Nascimento</label>
                        <input type="date" name="data_nascimento">
                    </div>
                    <div class="form-group">
                        <label>Naturalidade</label>
                        <input type="text" name="naturalidade">
                    </div>
                    <div class="form-group">
                        <label>UF</label>
                        <input type="text" name="uf_natural" maxlength="2">
                    </div>
                </div>
                <div class="grid-form" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Nome da Mãe</label>
                        <input type="text" name="mae">
                    </div>
                    <div class="form-group">
                        <label>Nome do Pai</label>
                        <input type="text" name="pai">
                    </div>
                </div>
            </div>

            <!-- LOCALIZAÇÃO -->
            <div class="section-card">
                <div class="section-title"><i class="fas fa-map-marker-alt"></i> Localização</div>
                <div class="grid-form">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Rua/Logradouro</label>
                        <input type="text" name="rua">
                    </div>
                    <div class="form-group">
                        <label>Número</label>
                        <input type="text" name="numero">
                    </div>
                    <div class="form-group">
                        <label>Bairro</label>
                        <input type="text" name="bairro">
                    </div>
                    <div class="form-group">
                        <label>Cidade</label>
                        <input type="text" name="cidade">
                    </div>
                    <div class="form-group">
                        <label>UF</label>
                        <input type="text" name="uf_endereco" maxlength="2" value="RO">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label>Ponto de Referência / Complemento</label>
                    <input type="text" name="complemento">
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label>Observações Táticas de Local</label>
                    <textarea name="obs_tacticas" rows="2" placeholder="Descreva características táticas relevantes do local..."></textarea>
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label>Link Google Maps</label>
                    <input type="text" name="link_mapa" placeholder="https://maps.google.com/...">
                </div>
            </div>

            <!-- INTELIGÊNCIA E OPERAÇÕES -->
            <div class="section-card">
                <div class="section-title"><i class="fas fa-brain"></i> Inteligência e Operações</div>
                
                <div class="form-group">
                    <label><i class="fas fa-user-secret"></i> Envolvimento Criminal / Histórico</label>
                    <textarea name="envolvimento_alvo" rows="4" placeholder="Descreva o envolvimento do alvo em atividades criminosas, facções, antecedentes..."></textarea>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label><i class="fas fa-clipboard-list"></i> Detalhes da Operação / Mandado</label>
                    <textarea name="detalhes_operacao" rows="4" placeholder="Informações sobre a operação em andamento, natureza do mandado, objetivos..."></textarea>
                </div>
                
                <!-- SEÇÃO DE DOCUMENTOS MELHORADA -->
                <div class="docs-section">
                    <div class="docs-header">
                        <i class="fas fa-folder-open" style="color: #ffd700; font-size: 20px;"></i>
                        <h4>Documentos Anexos</h4>
                        <span class="docs-counter" id="docs-counter">0</span>
                    </div>
                    
                    <div id="lista-documentos">
                        <div class="empty-docs">
                            <i class="fas fa-file-upload"></i>
                            <p>Nenhum documento anexado ainda</p>
                        </div>
                    </div>

                    <div class="docs-add-area">
                        <input type="file" id="input-documento" accept="application/pdf,image/*" style="display:none;" onchange="adicionarDocumento(this)">
                        
                        <div class="grid-form">
                            <div class="form-group">
                                <label><i class="fas fa-tag"></i> Tipo de Documento</label>
                                <select id="tipo-documento">
                                    <option value="mandado">Mandado Judicial</option>
                                    <option value="boletim">Boletim de Ocorrência</option>
                                    <option value="relatorio">Relatório de Investigação</option>
                                    <option value="oficio">Ofício</option>
                                    <option value="foto_investigacao">Foto de Investigação</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-edit"></i> Descrição (opcional)</label>
                                <input type="text" id="descricao-documento" placeholder="Ex: Mandado de busca e apreensão">
                            </div>
                        </div>
                        
                        <button type="button" class="btn-add-doc" onclick="document.getElementById('input-documento').click()">
                            <i class="fas fa-plus-circle"></i> Adicionar Documento
                        </button>
                    </div>
                </div>
            </div>

            <!-- GALERIA DE FOTOS -->
            <div class="section-card">
                <div class="section-title"><i class="fas fa-camera"></i> Galeria de Fotos do Alvo</div>
                <div class="photo-grid">
                    <div class="photo-upload">
                        <i class="fas fa-plus"></i>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'prev1')">
                        <img id="prev1" style="display:none;">
                    </div>
                    <div class="photo-upload">
                        <i class="fas fa-plus"></i>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'prev2')">
                        <img id="prev2" style="display:none;">
                    </div>
                    <div class="photo-upload">
                        <i class="fas fa-plus"></i>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'prev3')">
                        <img id="prev3" style="display:none;">
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-salvar" id="btnAcao">
                <i class="fas fa-save"></i> SALVAR REGISTRO OPERACIONAL
            </button>
        </form>
    </div>

    <!-- MODAL BUSCA -->
    <div id="modal-qr">
        <h2 style="color: #ffd700; margin-bottom: 20px;"><i class="fas fa-search"></i> Buscar Alvo por ID</h2>
        <input type="number" id="inputBuscaId" style="padding: 15px; font-size: 20px; width: 250px; text-align: center; border-radius: 10px; border: none;" placeholder="Digite o ID">
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="buscarPorId()" style="background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                <i class="fas fa-search"></i> BUSCAR
            </button>
            <button onclick="document.getElementById('modal-qr').style.display='none'" style="background: #dc3545; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                <i class="fas fa-times"></i> CANCELAR
            </button>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO DA API
        const API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
            ? "http://localhost:3000" 
            : window.location.origin;

        // Array para armazenar documentos
        let documentosAnexados = [];

        // MÁSCARAS
        VMasker(document.getElementById("cpf")).maskPattern("999.999.999-99");

        // FUNÇÕES DE FORMATAÇÃO DE TEXTO
        function formatarNome(texto) {
            if (!texto) return '';
            const preposicoes = ['de', 'do', 'da', 'dos', 'das', 'e'];
            return texto.toLowerCase().trim().split(/\s+/).map(palavra => {
                if (preposicoes.includes(palavra)) return palavra;
                return palavra.charAt(0).toUpperCase() + palavra.slice(1);
            }).join(' ');
        }

        function formatarFrase(texto) {
            if (!texto) return '';
            const limpo = texto.trim().toLowerCase();
            return limpo.charAt(0).toUpperCase() + limpo.slice(1);
        }

        // PREVIEW DE IMAGENS
        function previewImg(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ADICIONAR DOCUMENTO
        function adicionarDocumento(input) {
            const file = input.files[0];
            if (!file) return;

            // Validação de tamanho (máximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                Swal.fire('Arquivo muito grande', 'O arquivo deve ter no máximo 10MB', 'warning');
                input.value = '';
                return;
            }

            const tipo = document.getElementById('tipo-documento').value;
            const descricao = document.getElementById('descricao-documento').value || file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result.split(',')[1];
                
                const documento = {
                    tipo: tipo,
                    nome_arquivo: file.name,
                    descricao: descricao,
                    arquivo_base64: base64,
                    mime_type: file.type
                };

                documentosAnexados.push(documento);
                renderizarDocumentos();
                
                // Limpa os campos
                document.getElementById('descricao-documento').value = '';
                input.value = '';
                
                // Feedback visual
                Swal.fire({
                    icon: 'success',
                    title: 'Documento Adicionado',
                    text: file.name,
                    toast: true,
                    position: 'top-end',
                    timer: 2000,
                    showConfirmButton: false
                });
            };
            reader.readAsDataURL(file);
        }

        // RENDERIZAR LISTA DE DOCUMENTOS
        function renderizarDocumentos() {
            const lista = document.getElementById('lista-documentos');
            const counter = document.getElementById('docs-counter');
            
            counter.textContent = documentosAnexados.length;
            
            if (documentosAnexados.length === 0) {
                lista.innerHTML = '<div class="empty-docs"><i class="fas fa-file-upload"></i><p>Nenhum documento anexado ainda</p></div>';
                return;
            }

            const tipoLabel = {
                'mandado': 'Mandado Judicial',
                'boletim': 'Boletim de Ocorrência',
                'relatorio': 'Relatório',
                'oficio': 'Ofício',
                'foto_investigacao': 'Foto de Investigação',
                'outro': 'Outro Documento'
            };

            lista.innerHTML = documentosAnexados.map((doc, index) => {
                const icone = doc.mime_type.includes('pdf') ? 'fa-file-pdf' : 'fa-image';
                const tamanhoKB = (doc.arquivo_base64.length * 0.75 / 1024).toFixed(1);
                
                return `
                    <div class="doc-item">
                        <div class="doc-info">
                            <h4>
                                <i class="fas ${icone}"></i> 
                                ${tipoLabel[doc.tipo]}
                                <span class="doc-badge">${tamanhoKB} KB</span>
                            </h4>
                            <p><i class="fas fa-file"></i> ${doc.descricao}</p>
                        </div>
                        <button type="button" class="btn-remove-doc" onclick="removerDocumento(${index})" title="Remover documento">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // REMOVER DOCUMENTO
        function removerDocumento(index) {
            Swal.fire({
                title: 'Remover Documento?',
                text: 'Esta ação não pode ser desfeita',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e74c3c',
                confirmButtonText: 'Sim, remover',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    documentosAnexados.splice(index, 1);
                    renderizarDocumentos();
                    Swal.fire({
                        icon: 'success',
                        title: 'Removido',
                        toast: true,
                        position: 'top-end',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }

        // SUBMIT DO FORMULÁRIO
        document.getElementById('formCadastro').onsubmit = async (e) => {
            e.preventDefault();
            
            Swal.fire({ 
                title: 'Processando...', 
                html: `<p>Salvando dados e ${documentosAnexados.length} documento(s)...</p>`,
                allowOutsideClick: false, 
                didOpen: () => Swal.showLoading() 
            });

            const form = e.target;
            const formData = new FormData(form);
            const rawData = Object.fromEntries(formData.entries());

            // FORMATAÇÃO
            rawData.nome = formatarNome(rawData.nome);
            rawData.mae = formatarNome(rawData.mae);
            rawData.pai = formatarNome(rawData.pai);
            rawData.naturalidade = formatarNome(rawData.naturalidade);
            rawData.rua = formatarNome(rawData.rua);
            rawData.bairro = formatarNome(rawData.bairro);
            rawData.cidade = formatarNome(rawData.cidade);
            rawData.complemento = formatarFrase(rawData.complemento);
            rawData.obs_tacticas = formatarFrase(rawData.obs_tacticas);
            rawData.envolvimento_alvo = formatarFrase(rawData.envolvimento_alvo);
            rawData.detalhes_operacao = formatarFrase(rawData.detalhes_operacao);

            // METADADOS
            rawData.modo = form.dataset.modo;
            rawData.idEdicao = form.dataset.idEdicao;

            // FOTOS
            const getB64 = (id) => {
                const src = document.getElementById(id).src;
                return src && src.includes('base64') ? src.split(',')[1] : null;
            };
            rawData.foto1 = getB64('prev1');
            rawData.foto2 = getB64('prev2');
            rawData.foto3 = getB64('prev3');

            // DOCUMENTOS
            rawData.documentos = documentosAnexados;

            try {
                const res = await fetch(`${API_URL}/cadastrar-alvo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rawData)
                });
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire({
                        title: 'Sucesso!',
                        html: `
                            <p>${data.message}</p>
                            <h3 style="color: #28a745;">ID: ${data.id || 'N/A'}</h3>
                            <p><small>${data.documentos_salvos || 0} documento(s) salvos</small></p>
                        `,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Erro', data.error || 'Erro ao salvar', 'error');
                }
            } catch (err) {
                console.error(err);
                Swal.fire('Erro', 'Falha na conexão com servidor.', 'error');
            }
        };

        function resetarFormulario() { location.reload(); }
        function abrirBuscaQR() { document.getElementById('modal-qr').style.display = 'flex'; }

        async function buscarPorId() {
            const id = document.getElementById('inputBuscaId').value;
            if(!id) {
                Swal.fire('Atenção', 'Digite um ID válido', 'warning');
                return;
            }
            
            Swal.fire({ title: 'Buscando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                const res = await fetch(`${API_URL}/buscar-detalhes/${id}`);
                const data = await res.json();
                
                if(data && data.id) {
                    const form = document.getElementById('formCadastro');
                    form.dataset.modo = 'edicao';
                    form.dataset.idEdicao = data.id;
                    document.getElementById('btnAcao').innerHTML = `<i class="fas fa-edit"></i> ATUALIZAR REGISTRO ID: ${data.id}`;
                    document.getElementById('btnAcao').style.background = "linear-gradient(135deg, #ff8c00, #ff6b00)";
                    
                    // Preencher campos
                    Object.keys(data).forEach(key => {
                        const input = form.querySelector(`[name="${key}"]`);
                        if(input && key !== 'data_nascimento') input.value = data[key] || '';
                    });

                    if(data.data_nascimento) {
                        form.querySelector('[name="data_nascimento"]').value = data.data_nascimento.split('T')[0];
                    }

                    // Fotos
                    ['foto1', 'foto2', 'foto3'].forEach((foto, i) => {
                        if(data[foto]) {
                            const img = document.getElementById(`prev${i+1}`);
                            img.src = 'data:image/jpeg;base64,' + data[foto];
                            img.style.display = 'block';
                        }
                    });

                    // Documentos
                    if(data.documentos && data.documentos.length > 0) {
                        documentosAnexados = data.documentos.map(doc => ({
                            tipo: doc.tipo_documento,
                            nome_arquivo: doc.nome_arquivo,
                            descricao: doc.descricao,
                            arquivo_base64: doc.arquivo_base64,
                            mime_type: doc.mime_type
                        }));
                        renderizarDocumentos();
                    }

                    document.getElementById('modal-qr').style.display = 'none';
                    Swal.fire({
                        icon: 'info', 
                        title: 'Modo Edição Ativado', 
                        text: `Dados do ID ${data.id} carregados com sucesso`,
                        timer: 3000
                    });
                    window.scrollTo(0, 0);
                } else {
                    Swal.fire('Aviso', 'Alvo não encontrado.', 'warning');
                }
            } catch (err) {
                console.error(err);
                Swal.fire('Erro', 'Erro ao buscar dados.', 'error');
            }
        }

        // Inicializa a lista de documentos vazia
        renderizarDocumentos();
    </script>
</body>
</html>